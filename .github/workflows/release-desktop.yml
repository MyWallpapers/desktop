name: Desktop Release
run-name: "Release ${{ inputs.bump }} (${{ inputs.mode }})"

on:
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
      mode:
        description: 'Build mode'
        required: true
        type: choice
        options:
          - prod
          - dev

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.bump.outputs.version }}
      tag: ${{ steps.bump.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Bump version
        id: bump
        run: |
          CURRENT=$(grep -oP '"version":\s*"\K[0-9]+\.[0-9]+\.[0-9]+' src-tauri/tauri.conf.json | head -1)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"

          case "${{ inputs.bump }}" in
            patch) PATCH=$((PATCH + 1)) ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
          esac

          VERSION="$MAJOR.$MINOR.$PATCH"
          SUFFIX="${{ inputs.mode == 'dev' && '-dev' || '' }}"
          TAG="v${VERSION}${SUFFIX}"

          echo "ðŸ“¦ $CURRENT â†’ $VERSION (${{ inputs.bump }})"

          sed -i "s/\"version\": \"$CURRENT\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json
          sed -i "s/^version = \"$CURRENT\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          sed -i "s/\"version\": \"$CURRENT\"/\"version\": \"$VERSION\"/" package.json

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Commit and tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add src-tauri/tauri.conf.json src-tauri/Cargo.toml package.json
          git commit -m "release: desktop v${{ steps.bump.outputs.version }}"
          git tag "${{ steps.bump.outputs.tag }}"
          git push origin main "${{ steps.bump.outputs.tag }}"

  build-tauri:
    needs: bump-version
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: "--target aarch64-apple-darwin"
            artifact: macos-aarch64
          - platform: macos-latest
            args: "--target x86_64-apple-darwin"
            artifact: macos-x64
          # Linux paused â€” re-enable when WebGPU support is resolved
          # - platform: ubuntu-22.04
          #   args: ""
          #   artifact: linux
          - platform: windows-latest
            args: ""
            artifact: windows

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.bump-version.outputs.tag }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: "src-tauri -> target"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Configure dev build
        if: inputs.mode == 'dev'
        shell: bash
        run: |
          echo "CARGO_PROFILE_RELEASE_OPT_LEVEL=0" >> $GITHUB_ENV
          echo "CARGO_PROFILE_RELEASE_LTO=false" >> $GITHUB_ENV
          echo "CARGO_PROFILE_RELEASE_CODEGEN_UNITS=256" >> $GITHUB_ENV
          echo "CARGO_PROFILE_RELEASE_STRIP=none" >> $GITHUB_ENV
          echo "CARGO_PROFILE_RELEASE_INCREMENTAL=true" >> $GITHUB_ENV
          echo "CARGO_INCREMENTAL=1" >> $GITHUB_ENV

      - name: Build
        shell: bash
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: npx tauri build ${{ matrix.args }} ${{ inputs.mode == 'dev' && '--features devtools' || '' }}

      - name: Collect artifacts
        shell: bash
        run: |
          mkdir -p artifacts
          find src-tauri/target -path "*/bundle/*" -type f \( \
            -name "*.dmg" -o -name "*.exe" -o -name "*.msi" \
            -o -name "*.app.tar.gz" -o -name "*.app.tar.gz.sig" \
            -o -name "*.msi.sig" -o -name "*.msi.zip" -o -name "*.msi.zip.sig" \
            -o -name "*.exe.sig" -o -name "*.nsis.zip" -o -name "*.nsis.zip.sig" \
          \) -exec cp {} artifacts/ \;

          # Rename macOS .app.tar.gz to include arch (both builds produce identical filenames)
          if [ "${{ matrix.artifact }}" = "macos-aarch64" ]; then
            for f in artifacts/MyWallpaper.app.tar.gz*; do
              [ -f "$f" ] && mv "$f" "${f/MyWallpaper.app/MyWallpaper_aarch64.app}"
            done
          elif [ "${{ matrix.artifact }}" = "macos-x64" ]; then
            for f in artifacts/MyWallpaper.app.tar.gz*; do
              [ -f "$f" ] && mv "$f" "${f/MyWallpaper.app/MyWallpaper_x64.app}"
            done
          fi

          echo "=== Collected ==="
          ls -la artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: artifacts/*
          if-no-files-found: error

  publish-release:
    needs: [bump-version, build-tauri]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Create release and upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.bump-version.outputs.tag }}"
          VERSION="${{ needs.bump-version.outputs.version }}"
          REPO="${{ github.repository }}"
          PRERELEASE="${{ inputs.mode == 'dev' && '--prerelease' || '' }}"
          BODY="See the assets to download and install.${{ inputs.mode == 'dev' && ' âš ï¸ DEV BUILD â€” unoptimized, devtools enabled.' || '' }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"

          echo "=== Downloaded artifacts ==="
          find . -type f | sort
          echo ""

          # Create release and upload all binaries + signatures
          FILES=$(find . -type f \( -name "*.dmg" -o -name "*.exe" -o -name "*.msi" -o -name "*.app.tar.gz" -o -name "*.app.tar.gz.sig" -o -name "*.msi.sig" -o -name "*.msi.zip" -o -name "*.msi.zip.sig" -o -name "*.exe.sig" -o -name "*.nsis.zip" -o -name "*.nsis.zip.sig" \) | sort)

          if [ -z "$FILES" ]; then
            echo "::error::No release artifacts found"
            exit 1
          fi

          echo "=== Uploading to release ==="
          # shellcheck disable=SC2086
          gh release create "$TAG" \
            $PRERELEASE \
            --title "MyWallpaper Desktop ${TAG}" \
            --notes "$BODY" \
            --repo "$REPO" \
            $FILES

          echo "âœ… Release created with $(echo "$FILES" | wc -l) files"

          # Build updater manifest (latest.json)
          PUB_DATE=$(gh release view "$TAG" --json createdAt --jq '.createdAt' --repo "$REPO")
          PLATFORMS='{}'
          TMP_DIR=$(mktemp -d)

          SIG_FILES=$(find . -name "*.sig" -type f)
          for SIG_PATH in $SIG_FILES; do
            SIG_FILE=$(basename "$SIG_PATH")
            case "$SIG_FILE" in
              *_aarch64.app.tar.gz.sig)   PLATFORM="darwin-aarch64" ;;
              *_x64.app.tar.gz.sig)       PLATFORM="darwin-x86_64" ;;
              *_x64_en-US.msi.zip.sig)    PLATFORM="windows-x86_64" ;;
              *_x64-setup.nsis.zip.sig)   PLATFORM="windows-x86_64-nsis" ;;
              *) continue ;;
            esac

            ARTIFACT="${SIG_FILE%.sig}"
            URL="${BASE_URL}/${ARTIFACT}"
            SIG=$(cat "$SIG_PATH")

            PLATFORMS=$(echo "$PLATFORMS" | jq \
              --arg p "$PLATFORM" \
              --arg s "$SIG" \
              --arg u "$URL" \
              '. + {($p): {signature: $s, url: $u}}')

            echo "  âœ“ $PLATFORM â†’ $ARTIFACT"
          done

          PLATFORM_COUNT=$(echo "$PLATFORMS" | jq 'keys | length')
          if [ "$PLATFORM_COUNT" -eq 0 ]; then
            echo "::error::No updater platforms found"
            exit 1
          fi

          jq -n \
            --arg version "$VERSION" \
            --arg notes "$BODY" \
            --arg pub_date "$PUB_DATE" \
            --argjson platforms "$PLATFORMS" \
            '{version: $version, notes: $notes, pub_date: $pub_date, platforms: $platforms}' > latest.json

          echo "Generated latest.json with $PLATFORM_COUNT platforms:"
          jq . latest.json

          gh release upload "$TAG" latest.json --repo "$REPO"
          echo "âœ… Updater manifest uploaded"
